<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Watchlist – Filme, Serien & Dokus</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    :root{
      --olive-950:#070b08;
      --olive-900:#0f1b12;
      --olive-850:#122015;
      --olive-800:#152417;
      --olive-700:#1c2f1f;
      --olive-600:#233a26;
      --olive-500:#2b4530;
      --olive-400:#3b5a40;
      --olive-300:#5a7d46;
      --olive-glow:#92b36f;
      --white:#f8fafc;
      --muted:rgba(248,250,252,0.75);
      --muted-2:rgba(248,250,252,0.55);
      --line:rgba(255,255,255,0.08);
    }

    body {
      color: var(--white);
      min-height: 100vh;
      display: flex;
      background:
        radial-gradient(1200px 800px at -10% -10%, rgba(146,179,111,0.45) 0%, transparent 60%),
        radial-gradient(1000px 800px at 110% 0%, rgba(88,140,86,0.5) 0%, transparent 62%),
        radial-gradient(900px 900px at 50% 120%, rgba(180,210,140,0.3) 0%, transparent 60%),
        linear-gradient(180deg, var(--olive-900) 0%, var(--olive-950) 100%);
    }

    /* ---------- Layout Desktop ---------- */
    .sidebar {
      width: 280px;
      border-right: 1px solid var(--line);
      padding: 18px;
      background:
        linear-gradient(180deg, rgba(15,27,18,0.9), rgba(7,11,8,0.9));
      backdrop-filter: blur(6px);
    }

    .main {
      flex: 1;
      padding: 18px;
    }

    h1 {
      font-size: 20px;
      margin-bottom: 12px;
      font-weight: 800;
      letter-spacing: .2px;
    }

    h2 {
      font-size: 16px;
      margin-bottom: 8px;
      font-weight: 700;
      letter-spacing: .2px;
    }

    .btn {
      border: 1px solid var(--line);
      background: linear-gradient(180deg, #3f5f43, #2b4530);
      color: var(--white);
      padding: 7px 11px;
      border-radius: 10px;
      font-size: 12px;
      cursor: pointer;
      box-shadow: 0 6px 14px rgba(0,0,0,0.35);
    }
    .btn:hover { filter: brightness(1.05); }

    .btn-icon {
      border: 1px solid var(--line);
      background:
        radial-gradient(120% 120% at 20% 10%, #a8c67a 0%, #5a7d46 45%, #2b4530 100%);
      color: var(--white);
      width: 30px;
      height: 30px;
      border-radius: 999px;
      font-size: 18px;
      line-height: 1;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 8px 18px rgba(0,0,0,0.45);
    }
    .btn-icon:hover { filter: brightness(1.05); }

    .btn-danger {
      background: linear-gradient(180deg,#b91c1c,#7f1212);
      border-color: rgba(255,255,255,0.1);
    }

    .input, .select {
      width: 100%;
      padding: 7px 9px;
      border-radius: 10px;
      border: 1px solid var(--line);
      background: rgba(12,20,14,0.95);
      color: var(--white);
      font-size: 12px;
      margin-bottom: 6px;
    }

    .label {
      font-size: 11px;
      color: var(--muted-2);
      margin-bottom: 2px;
      display: block;
      font-weight: 600;
    }

    .text-xs {
      font-size: 10px;
      color: var(--muted-2);
      text-transform: uppercase;
      letter-spacing: 0.06em;
      margin: 10px 0 6px;
    }

    /* ---------- Search ---------- */
    .search-wrap {
      display: grid;
      grid-template-columns: 2fr 1fr auto;
      gap: 8px;
      align-items: center;
      margin: 8px 0 12px;
      padding: 10px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,0.06);
      border-radius: 14px;
      box-shadow: 0 8px 18px rgba(0,0,0,0.35);
      backdrop-filter: blur(6px);
    }

    .search-input, .search-select {
      width: 100%;
      padding: 9px 11px;
      border-radius: 12px;
      border: 1px solid var(--line);
      background: rgba(15,27,18,0.95);
      color: var(--white);
      font-size: 13px;
      font-weight: 700;
    }
    .search-input::placeholder { color: var(--muted-2); font-weight: 600; }

    .toggle {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      color: var(--white);
      white-space: nowrap;
      user-select: none;
      font-weight: 700;
    }
    .toggle input {
      width: 18px;
      height: 18px;
      accent-color: #8fb56a;
      cursor: pointer;
    }

    /* ---------- Kategorien Desktop ---------- */
    .category-button {
      width: 100%;
      text-align: left;
      border: 1px solid var(--line);
      background:
        radial-gradient(140% 140% at 15% 10%, #3f5f43 0%, #2a452f 45%, #152417 100%);
      color: var(--white);
      font-size: 12px;
      padding: 8px 10px;
      border-radius: 12px;
      margin-bottom: 8px;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 6px;
      position: relative;
      box-shadow:
        0 8px 18px rgba(0,0,0,0.45),
        inset 0 0 0 1px rgba(255,255,255,0.03);
    }
    .category-button:hover { filter: brightness(1.05); }
    .category-button.active {
      box-shadow:
        0 10px 22px rgba(0,0,0,0.55),
        0 0 0 2px rgba(146,179,111,0.6);
    }
    .category-button .chev { font-size: 10px; opacity: 0.8; }

    .category-button.sub {
      background: rgba(21,36,23,0.9);
      font-weight: 700;
    }

    .count {
      font-size: 10px;
      color: var(--muted);
      margin-left: auto;
      padding-left: 8px;
      flex-shrink: 0;
      font-weight: 800;
    }
    .count.muted { color: var(--muted-2); }

    .badge-count {
      display: none;
      position: absolute;
      right: 8px;
      top: -6px;
      width: 26px;
      height: 26px;
      border-radius: 999px;
      color: var(--white);
      font-size: 11px;
      font-weight: 900;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 2px solid rgba(255,255,255,0.9);
      background:
        radial-gradient(120% 120% at 20% 10%, #bddd8a 0%, #7ea65b 45%, #3a5a40 100%);
      box-shadow: 0 6px 14px rgba(0,0,0,0.45);
    }

    /* ---------- Cards ---------- */
    .card {
      background: rgba(18,31,20,0.92);
      border-radius: 18px;
      border: 1px solid var(--line);
      padding: 14px;
      margin-bottom: 12px;
      display: flex;
      gap: 12px;
      align-items: flex-start;
      font-size: 13px;
      box-shadow:
        0 10px 22px rgba(0,0,0,0.55),
        inset 0 0 0 1px rgba(255,255,255,0.02);
      backdrop-filter: blur(6px);
    }

    .card img {
      width: 64px;
      height: 96px;
      object-fit: cover;
      border-radius: 12px;
      flex-shrink: 0;
      box-shadow: 0 6px 12px rgba(0,0,0,0.55);
    }

    .badge {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--muted);
      margin-left: 6px;
      font-weight: 800;
    }

    .status { font-size: 11px; color: var(--muted); margin-bottom: 2px; }
    .small { font-size: 11px; color: var(--muted); }
    .muted { font-size: 12px; color: var(--muted-2); font-style: italic; margin-top: 6px; }

    .flex { display: flex; }
    .flex-between { display: flex; justify-content: space-between; align-items: center; }
    .mt-8 { margin-top: 8px; }
    .mt-12 { margin-top: 12px; }
    .gap-8 { gap: 8px; }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 8px;
    }

    .hidden { display: none; }

    /* ---------- Stats Box ---------- */
    .stats {
      margin-top: 14px;
      padding: 12px;
      border-radius: 14px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,0.06);
      box-shadow: 0 8px 18px rgba(0,0,0,0.35);
      backdrop-filter: blur(6px);
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
    }
    .stat-card{
      background: rgba(15,27,18,0.95);
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 10px;
      text-align: center;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.02);
    }
    .stat-title{
      font-size: 12px;
      font-weight: 800;
      color: var(--muted);
      letter-spacing: .3px;
    }
    .stat-value{
      margin-top: 4px;
      font-size: 20px;
      font-weight: 900;
      color: var(--white);
    }

    /* ---------- Modal ---------- */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(10, 18, 12, 0.85);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }

    .modal {
      background: rgba(10,18,12,0.98);
      border-radius: 14px;
      border: 1px solid var(--line);
      padding: 16px;
      max-width: 520px;
      width: 100%;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.6);
      color: var(--white);
      backdrop-filter: blur(8px);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .modal-title { font-size: 16px; font-weight: 800; }

    .modal-close {
      border: none;
      background: transparent;
      color: var(--muted);
      font-size: 18px;
      cursor: pointer;
      line-height: 1;
    }

    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 12px;
    }

    .modal-backdrop.hidden { display: none; }

    /* =========================================================
       ========== MOBILE – FLUENT OLIVE GRID ==========
       ========================================================= */
    @media (max-width: 800px) {
      body{ flex-direction: column; }

      .sidebar{
        width:100%;
        border:none;
        padding:18px 16px 10px;
        background:transparent;
      }
      h1{ display:none; }
      #btnAll, .text-xs{ display:none; }

      .main{ padding:8px 16px 22px; }

      #addEntryBtn{
        position:fixed;
        top:14px;
        right:14px;
        z-index:90;
        width:58px;
        height:58px;
        font-size:30px;
        color:var(--white);
        background:
          radial-gradient(120% 120% at 20% 10%, #a8c67a 0%, #5a7d46 45%, #2b4530 100%);
        border:1px solid rgba(255,255,255,0.22);
        box-shadow:
          0 14px 30px rgba(0,0,0,0.6),
          inset 0 0 0 1px rgba(255,255,255,0.15);
        backdrop-filter: blur(6px);
      }

      #categoryList{
        display:grid;
        grid-template-columns:repeat(2,minmax(0,1fr));
        gap:12px;
        margin-top:10px;
      }

      .category-button.root{
        aspect-ratio:1/1;
        width:100%;
        color:var(--white);
        border:none;
        border-radius:22px;
        padding:14px;
        font-size:18px;
        font-weight:800;
        display:flex;
        align-items:center;
        justify-content:center;
        text-align:center;
        position:relative;
        background:
          radial-gradient(140% 140% at 15% 10%, #3f5f43 0%, #2a452f 45%, #152417 100%);
        box-shadow:
          0 10px 22px rgba(0,0,0,0.55),
          inset 0 0 0 1px rgba(255,255,255,0.06),
          inset 0 10px 30px rgba(255,255,255,0.03);
      }
      .category-button.root.active{
        transform:translateY(-1px);
        box-shadow:
          0 12px 26px rgba(0,0,0,0.6),
          0 0 0 2px rgba(146,179,111,0.7),
          inset 0 0 0 1px rgba(255,255,255,0.09);
      }
      .category-button.root .badge-count{ display:flex; }
      .category-button.root .count{ display:none; }
      .badge-count{
        right:10px; top:10px;
        width:28px; height:28px;
        font-size:12px; font-weight:900;
      }
      .category-button.root .chev{ display:none; }

      .category-button.sub{
        grid-column:1/-1;
        background:rgba(21,36,23,0.9);
        color:var(--white);
        border:1px solid rgba(255,255,255,0.06);
        border-radius:16px;
        padding:14px;
        font-size:15px;
        font-weight:700;
        display:flex;
        justify-content:space-between;
        align-items:center;
        min-height:54px;
        box-shadow:0 8px 18px rgba(0,0,0,0.5);
      }
      .category-button.sub.active{
        background: linear-gradient(90deg, #3f5f43 0%, #6c9152 55%, #8fb56a 100%);
        border-color:transparent;
        box-shadow: 0 10px 22px rgba(0,0,0,0.6), 0 0 0 2px rgba(146,179,111,0.55);
      }

      .search-wrap{
        grid-template-columns:1fr;
        border-radius:16px;
      }

      #entriesTitle,#entriesCount{ display:none; }

      .form-grid{ grid-template-columns:1fr !important; }
      .modal-backdrop{ align-items:flex-end; }
      .modal{
        max-width:none; width:100%;
        border-radius:18px 18px 0 0;
      }

      .stats{ grid-template-columns: 1fr 1fr 1fr; }
    }
  </style>
</head>
<body>

  <div class="sidebar" id="sidebar">
    <h1>Watchlist Kategorien</h1>

    <button id="btnAll" class="category-button active">
      <span>Alle Einträge</span>
    </button>

    <div class="text-xs">Kategorien</div>
    <div id="categoryList"></div>
  </div>

  <div class="main">
    <section class="mt-12">
      <div class="flex-between">
        <h2 id="entriesTitle">Alle Einträge</h2>
        <div class="flex gap-8" style="align-items: center;">
          <div id="entriesCount" class="small">0 Einträge</div>
          <button id="addEntryBtn" class="btn-icon" title="Neuen Eintrag hinzufügen">+</button>
        </div>
      </div>

      <div class="search-wrap">
        <input id="searchInput" class="search-input" placeholder="Suche nach Titel…" />
        <select id="searchCategory" class="search-select">
          <option value="">Alle Kategorien</option>
        </select>
        <label class="toggle">
          <input type="checkbox" id="filterAmSchauen" />
          nur „Am Schauen“
        </label>
      </div>

      <div id="entriesList" class="mt-8"></div>

      <!-- Statistik unten -->
      <div id="statsBox" class="stats">
        <div class="stat-card">
          <div class="stat-title">Geschaut – Filme</div>
          <div id="statFilms" class="stat-value">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-title">Geschaut – Serien</div>
          <div id="statSeries" class="stat-value">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-title">Geschaut – Dokus</div>
          <div id="statDokus" class="stat-value">0</div>
        </div>
      </div>
    </section>
  </div>

  <!-- Modal -->
  <div id="entryModal" class="modal-backdrop hidden" aria-hidden="true">
    <div class="modal">
      <div class="modal-header">
        <div id="entryModalTitle" class="modal-title">Neuer Eintrag</div>
        <button id="entryModalClose" class="modal-close" aria-label="Schließen">&times;</button>
      </div>

      <form id="entryForm">
        <div class="form-grid">
          <div>
            <label class="label" for="entryTitle">Titel</label>
            <input id="entryTitle" class="input" placeholder="z.B. The Expanse" />
          </div>
          <div>
            <label class="label" for="entryType">Typ</label>
            <select id="entryType" class="select">
              <option value="film">Film</option>
              <option value="serie">Serie</option>
              <option value="doku">Dokumentation</option>
            </select>
          </div>
          <div>
            <label class="label" for="entryStatus">Status</label>
            <select id="entryStatus" class="select">
              <option value="geplant">Geplant</option>
              <option value="am_schauen">Am Schauen</option>
              <option value="fertig">Fertig</option>
            </select>
          </div>
          <div>
            <label class="label" for="entryCategory">Kategorie</label>
            <select id="entryCategory" class="select">
              <option value="">Bitte wählen…</option>
            </select>
          </div>
          <div>
            <label class="label" for="entryRating">Bewertung (1–10)</label>
            <input id="entryRating" type="number" min="1" max="10" class="input" />
          </div>
          <div style="grid-column: span 3;">
            <label class="label" for="entryNote">Notiz</label>
            <input id="entryNote" class="input" placeholder="z.B. Staffel 3 schwächer..." />
          </div>
        </div>

        <div id="progressWrapper" class="form-grid mt-8 hidden">
          <div id="seriesProgress" class="hidden" style="grid-column: span 2;">
            <label class="label" for="entrySeason">Staffel</label>
            <input id="entrySeason" type="number" min="1" class="input" />
          </div>
          <div id="seriesProgress2" class="hidden" style="grid-column: span 2;">
            <label class="label" for="entryEpisode">Folge</label>
            <input id="entryEpisode" type="number" min="1" class="input" />
          </div>

          <div id="movieProgress" class="hidden" style="grid-column: span 4;">
            <label class="label" for="entryMinutes">Minuten (Fortschritt)</label>
            <input id="entryMinutes" type="number" min="1" class="input" />
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" id="entryModalCancel" class="btn btn-danger" style="background:#111827;border:1px solid #1f2937;">
            Abbrechen
          </button>
          <button type="submit" id="entryModalSubmit" class="btn">
            Eintrag speichern
          </button>
        </div>
      </form>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
    import {
      getFirestore,
      collection,
      addDoc,
      getDocs,
      query,
      orderBy,
      updateDoc,
      deleteDoc,
      doc
    } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBuuUcEg8ZMBlvJKEQJaz9rtOnH81aEgfo",
      authDomain: "film-serien.firebaseapp.com",
      projectId: "film-serien",
      storageBucket: "film-serien.firebasestorage.app",
      messagingSenderId: "716417741276",
      appId: "1:716417741276:web:3d19ab50c8effb64001f19"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const entriesCollection = collection(db, "entries");

    const categories = [
      { id: 1, name: "Filme",           parentId: null },
      { id: 2, name: "Serien",          parentId: null },
      { id: 3, name: "Dokumentationen", parentId: null },

      { id: 10, name: "Drama",           parentId: 1 },
      { id: 11, name: "Komödie",         parentId: 1 },
      { id: 12, name: "Action",          parentId: 1 },
      { id: 13, name: "Krimi",           parentId: 1 },
      { id: 14, name: "Horror",          parentId: 1 },
      { id: 15, name: "Science-Fiction", parentId: 1 },
      { id: 16, name: "Fantasy",         parentId: 1 },
      { id: 17, name: "Romance",         parentId: 1 },
      { id: 18, name: "Abstrakt",        parentId: 1 },
      { id: 19, name: "Thriller",        parentId: 1 },
      { id: 20, name: "Musical",         parentId: 1 },
      { id: 21, name: "Disney-Filme",    parentId: 1 },
      { id: 22, name: "Pixar-Filme",     parentId: 1 },

      { id: 30, name: "Drama",           parentId: 2 },
      { id: 31, name: "Komödie",         parentId: 2 },
      { id: 32, name: "Action",          parentId: 2 },
      { id: 33, name: "Krimi",           parentId: 2 },
      { id: 34, name: "Horror",          parentId: 2 },
      { id: 35, name: "Science-Fiction", parentId: 2 },
      { id: 36, name: "Fantasy",         parentId: 2 },
      { id: 37, name: "Romance",         parentId: 2 },
      { id: 38, name: "Abstrakt",        parentId: 2 },
      { id: 39, name: "Thriller",        parentId: 2 },
      { id: 40, name: "Musical",         parentId: 2 },

      { id: 50, name: "Drama",           parentId: 3 },
      { id: 51, name: "Komödie",         parentId: 3 },
      { id: 52, name: "Action",          parentId: 3 },
      { id: 53, name: "Krimi",           parentId: 3 },
      { id: 54, name: "Horror",          parentId: 3 },
      { id: 55, name: "Science-Fiction", parentId: 3 },
      { id: 56, name: "Fantasy",         parentId: 3 },
      { id: 57, name: "Romance",         parentId: 3 },
      { id: 58, name: "Abstrakt",        parentId: 3 },
      { id: 59, name: "Thriller",        parentId: 3 },
      { id: 60, name: "Musical",         parentId: 3 }
    ];

    let entries = [];
    let selectedCategoryId = null;
    let editingEntryId = null;

    let searchText = "";
    let searchCategoryId = null;
    let onlyAmSchauen = false;

    let expandedRoots = new Set();

    // DOM
    const categoryListEl   = document.getElementById("categoryList");
    const entryCategoryEl  = document.getElementById("entryCategory");
    const entriesListEl    = document.getElementById("entriesList");
    const entriesTitleEl   = document.getElementById("entriesTitle");
    const entriesCountEl   = document.getElementById("entriesCount");
    const btnAllEl         = document.getElementById("btnAll");
    const addEntryBtn      = document.getElementById("addEntryBtn");

    const searchInputEl    = document.getElementById("searchInput");
    const searchCategoryEl = document.getElementById("searchCategory");
    const filterAmSchauenEl= document.getElementById("filterAmSchauen");

    const entryForm        = document.getElementById("entryForm");
    const entryTitle       = document.getElementById("entryTitle");
    const entryType        = document.getElementById("entryType");
    const entryStatus      = document.getElementById("entryStatus");
    const entryRating      = document.getElementById("entryRating");
    const entryNote        = document.getElementById("entryNote");
    const entryModal       = document.getElementById("entryModal");
    const entryModalTitle  = document.getElementById("entryModalTitle");
    const entryModalClose  = document.getElementById("entryModalClose");
    const entryModalCancel = document.getElementById("entryModalCancel");
    const entryModalSubmit = document.getElementById("entryModalSubmit");

    const progressWrapper  = document.getElementById("progressWrapper");
    const seriesProgress   = document.getElementById("seriesProgress");
    const seriesProgress2  = document.getElementById("seriesProgress2");
    const movieProgress    = document.getElementById("movieProgress");
    const entrySeason      = document.getElementById("entrySeason");
    const entryEpisode     = document.getElementById("entryEpisode");
    const entryMinutes     = document.getElementById("entryMinutes");

    // Stats DOM
    const statFilmsEl  = document.getElementById("statFilms");
    const statSeriesEl = document.getElementById("statSeries");
    const statDokusEl  = document.getElementById("statDokus");

    function getCategoryById(id) {
      return categories.find(c => c.id === id) || null;
    }

    function getRootCategoryIdForType(type) {
      if (type === "film") return 1;
      if (type === "serie") return 2;
      if (type === "doku") return 3;
      return null;
    }

    function getCategoryPath(id) {
      const names = [];
      let current = getCategoryById(id);
      while (current) {
        names.unshift(current.name);
        current = current.parentId ? getCategoryById(current.parentId) : null;
      }
      return names.join(" › ");
    }

    function formatTypeLabel(type) {
      if (type === "film") return "Film";
      if (type === "serie") return "Serie";
      if (type === "doku") return "Dokumentation";
      return type;
    }

    async function fetchPosterUrl(title, type) { return null; }

    function renderCategoryOptionsForType(type, selectedId = null) {
      entryCategoryEl.innerHTML = '<option value="">Bitte wählen…</option>';
      const rootId = getRootCategoryIdForType(type);
      if (!rootId) return;

      const subs = categories.filter(c => c.parentId === rootId);
      subs.forEach(c => {
        const option = document.createElement("option");
        option.value = String(c.id);
        option.textContent = c.name;
        if (selectedId && Number(selectedId) === c.id) option.selected = true;
        entryCategoryEl.appendChild(option);
      });
    }

    function renderSearchCategoryDropdown() {
      searchCategoryEl.innerHTML = '<option value="">Alle Kategorien</option>';
      const roots = categories.filter(c => c.parentId == null);
      roots.forEach(root => {
        const optRoot = document.createElement("option");
        optRoot.value = String(root.id);
        optRoot.textContent = root.name;
        searchCategoryEl.appendChild(optRoot);
        categories.filter(c => c.parentId === root.id).forEach(sub => {
          const opt = document.createElement("option");
          opt.value = String(sub.id);
          opt.textContent = "— " + sub.name;
          searchCategoryEl.appendChild(opt);
        });
      });
    }

    function updateProgressFields() {
      const status = entryStatus.value;
      const type = entryType.value;

      progressWrapper.classList.add("hidden");
      seriesProgress.classList.add("hidden");
      seriesProgress2.classList.add("hidden");
      movieProgress.classList.add("hidden");

      if (status !== "am_schauen") {
        entrySeason.value = "";
        entryEpisode.value = "";
        entryMinutes.value = "";
        return;
      }

      progressWrapper.classList.remove("hidden");
      if (type === "serie") {
        seriesProgress.classList.remove("hidden");
        seriesProgress2.classList.remove("hidden");
        entryMinutes.value = "";
      } else {
        movieProgress.classList.remove("hidden");
        entrySeason.value = "";
        entryEpisode.value = "";
      }
    }

    function openCreateModal() {
      editingEntryId = null;
      entryModalTitle.textContent = "Neuer Eintrag";
      entryModalSubmit.textContent = "Eintrag speichern";
      resetForm();
      updateProgressFields();
      entryModal.classList.remove("hidden");
      entryModal.setAttribute("aria-hidden", "false");
    }

    function openEditModal(entry) {
      editingEntryId = entry.id;
      entryModalTitle.textContent = "Eintrag bearbeiten";
      entryModalSubmit.textContent = "Eintrag aktualisieren";

      entryTitle.value = entry.title;
      entryType.value = entry.type;
      entryStatus.value = entry.status;
      entryRating.value = entry.rating != null ? entry.rating : "";
      entryNote.value = entry.note || "";

      entrySeason.value = entry.season != null ? entry.season : "";
      entryEpisode.value = entry.episode != null ? entry.episode : "";
      entryMinutes.value = entry.minutes != null ? entry.minutes : "";

      renderCategoryOptionsForType(entry.type, entry.categoryId);
      updateProgressFields();

      entryModal.classList.remove("hidden");
      entryModal.setAttribute("aria-hidden", "false");
    }

    function closeModal() {
      entryModal.classList.add("hidden");
      entryModal.setAttribute("aria-hidden", "true");
      resetForm();
    }

    function renderCategories() {
      categoryListEl.innerHTML = "";

      const roots = categories.filter(c => c.parentId == null);
      const subsByRoot = (rootId) => categories.filter(c => c.parentId === rootId);

      function countEntriesForCategory(catId) {
        const allowedIds = new Set();
        function collect(id) {
          allowedIds.add(id);
          categories.filter(c => c.parentId === id).forEach(ch => collect(ch.id));
        }
        collect(catId);
        return entries.filter(e => allowedIds.has(e.categoryId)).length;
      }

      roots.forEach(root => {
        const isExpanded = expandedRoots.has(root.id);
        const rootCount = countEntriesForCategory(root.id);

        const rootBtn = document.createElement("button");
        rootBtn.className =
          "category-button root" + (root.id === selectedCategoryId ? " active" : "");

        rootBtn.innerHTML = `
          <span>${root.name}</span>
          <span class="count ${rootCount === 0 ? "muted" : ""}">${rootCount}</span>
          <span class="badge-count">${rootCount}</span>
          <span class="chev">${isExpanded ? "▼" : "▶"}</span>
        `;

        rootBtn.addEventListener("click", () => {
          if (expandedRoots.has(root.id)) expandedRoots.delete(root.id);
          else expandedRoots.add(root.id);

          selectedCategoryId = root.id;
          renderCategories();
          renderEntries();
        });

        categoryListEl.appendChild(rootBtn);

        if (isExpanded) {
          subsByRoot(root.id).forEach(sub => {
            const subCount = countEntriesForCategory(sub.id);

            const subBtn = document.createElement("button");
            subBtn.className =
              "category-button sub" + (sub.id === selectedCategoryId ? " active" : "");

            subBtn.innerHTML = `
              <span>${sub.name}</span>
              <span class="count ${subCount === 0 ? "muted" : ""}">${subCount}</span>
            `;

            subBtn.addEventListener("click", (e) => {
              e.stopPropagation();
              selectedCategoryId = sub.id;
              renderCategories();
              renderEntries();
            });

            categoryListEl.appendChild(subBtn);
          });
        }
      });

      const allCount = entries.length;
      btnAllEl.innerHTML = `
        <span>Alle Einträge</span>
        <span class="count ${allCount === 0 ? "muted" : ""}">${allCount}</span>
      `;
      if (selectedCategoryId === null) btnAllEl.classList.add("active");
      else btnAllEl.classList.remove("active");
    }

    function renderStats() {
      const watched = entries.filter(e => e.status === "fertig");
      const films  = watched.filter(e => e.type === "film").length;
      const series = watched.filter(e => e.type === "serie").length;
      const dokus  = watched.filter(e => e.type === "doku").length;

      statFilmsEl.textContent  = films;
      statSeriesEl.textContent = series;
      statDokusEl.textContent  = dokus;
    }

    function renderEntries() {
      let visibleEntries = entries;
      const activeCategoryId =
        searchCategoryId != null ? searchCategoryId : selectedCategoryId;

      if (activeCategoryId !== null) {
        const allowedIds = new Set();
        function collect(catId) {
          allowedIds.add(catId);
          categories.filter(c => c.parentId === catId).forEach(child => collect(child.id));
        }
        collect(activeCategoryId);
        visibleEntries = visibleEntries.filter(e => allowedIds.has(e.categoryId));
      }

      if (searchText.trim()) {
        const q = searchText.trim().toLowerCase();
        visibleEntries = visibleEntries.filter(e =>
          (e.title || "").toLowerCase().includes(q)
        );
      }

      if (onlyAmSchauen) {
        visibleEntries = visibleEntries.filter(e => e.status === "am_schauen");
      }

      entriesListEl.innerHTML = "";
      entriesTitleEl.textContent =
        activeCategoryId === null
          ? "Alle Einträge"
          : "Einträge in: " + getCategoryPath(activeCategoryId);

      entriesCountEl.textContent =
        visibleEntries.length + " Eintrag" + (visibleEntries.length === 1 ? "" : "e");

      if (visibleEntries.length === 0) {
        const div = document.createElement("div");
        div.className = "muted";
        div.textContent = "Keine Treffer.";
        entriesListEl.appendChild(div);
        return;
      }

      visibleEntries.forEach(entry => {
        const card = document.createElement("div");
        card.className = "card";

        if (entry.posterUrl) {
          const img = document.createElement("img");
          img.src = entry.posterUrl;
          img.alt = entry.title;
          card.appendChild(img);
        }

        const content = document.createElement("div");
        content.style.flex = "1";

        const topLine = document.createElement("div");
        topLine.className = "flex-between";

        const titleEl = document.createElement("div");
        titleEl.innerHTML =
          `<div style="font-weight:900;font-size:15px;line-height:1.2">${entry.title}</div>
           <div class="badge" style="margin-left:0;margin-top:2px">${formatTypeLabel(entry.type)}</div>`;
        topLine.appendChild(titleEl);

        const ratingEl = document.createElement("div");
        ratingEl.className = "small";
        if (entry.rating != null) ratingEl.textContent = "Rating: " + entry.rating + "/10";
        topLine.appendChild(ratingEl);

        const catLine = document.createElement("div");
        catLine.className = "small";
        catLine.textContent = getCategoryPath(entry.categoryId);

        const statusLine = document.createElement("div");
        statusLine.className = "status";
        const niceStatus = entry.status.replace("_", " ");
        statusLine.innerHTML = `
          <span style="
            display:inline-flex;
            padding:4px 8px;
            border-radius:999px;
            font-size:11px;
            font-weight:800;
            background:${entry.status==="am_schauen" ? "rgba(146,179,111,0.18)" :
                       entry.status==="fertig" ? "rgba(255,255,255,0.12)" :
                       "rgba(255,255,255,0.08)"};
            color:#f8fafc;
          ">
            ${niceStatus}
          </span>
        `;

        content.appendChild(topLine);
        content.appendChild(catLine);
        content.appendChild(statusLine);

        if (entry.status === "am_schauen") {
          const prog = document.createElement("div");
          prog.className = "small";
          prog.style.marginTop = "2px";
          if (entry.type === "serie" && (entry.season || entry.episode)) {
            prog.textContent = `Fortschritt: Staffel ${entry.season ?? "?"}, Folge ${entry.episode ?? "?"}`;
          } else if ((entry.type === "film" || entry.type === "doku") && entry.minutes) {
            prog.textContent = `Fortschritt: ${entry.minutes} min`;
          }
          content.appendChild(prog);
        }

        if (entry.note) {
          const noteEl = document.createElement("div");
          noteEl.className = "small";
          noteEl.textContent = entry.note;
          noteEl.style.marginTop = "4px";
          content.appendChild(noteEl);
        }

        card.appendChild(content);

        const actions = document.createElement("div");
        actions.style.display = "flex";
        actions.style.flexDirection = "column";
        actions.style.gap = "6px";

        const editBtn = document.createElement("button");
        editBtn.textContent = "Bearbeiten";
        editBtn.className = "btn";
        editBtn.style.fontSize = "10px";
        editBtn.style.padding = "5px 7px";
        editBtn.addEventListener("click", () => openEditModal(entry));

        const deleteBtn = document.createElement("button");
        deleteBtn.textContent = "Löschen";
        deleteBtn.className = "btn btn-danger";
        deleteBtn.style.fontSize = "10px";
        deleteBtn.style.padding = "5px 7px";
        deleteBtn.addEventListener("click", () => deleteEntry(entry));

        actions.appendChild(editBtn);
        actions.appendChild(deleteBtn);
        card.appendChild(actions);

        entriesListEl.appendChild(card);
      });
    }

    async function loadEntries() {
      const qEntries = query(entriesCollection, orderBy("createdAt", "desc"));
      const snapshot = await getDocs(qEntries);
      entries = snapshot.docs.map(docSnap => {
        const data = docSnap.data();
        return {
          id: docSnap.id,
          title: data.title,
          type: data.type,
          status: data.status,
          categoryId: Number(data.categoryId),
          rating: data.rating ?? null,
          note: data.note ?? "",
          posterUrl: data.posterUrl ?? null,
          season: data.season ?? null,
          episode: data.episode ?? null,
          minutes: data.minutes ?? null
        };
      });
      renderSearchCategoryDropdown();
      renderCategories();
      renderEntries();
      renderStats();
    }

    async function deleteEntry(entry) {
      const confirmDelete = confirm(`Eintrag "${entry.title}" wirklich löschen?`);
      if (!confirmDelete) return;
      await deleteDoc(doc(db, "entries", entry.id));
      await loadEntries();
    }

    function resetForm() {
      entryTitle.value = "";
      entryRating.value = "";
      entryNote.value = "";
      entryStatus.value = "geplant";
      entryType.value = "film";
      entrySeason.value = "";
      entryEpisode.value = "";
      entryMinutes.value = "";
      renderCategoryOptionsForType("film");
      editingEntryId = null;
      updateProgressFields();
    }

    entryType.addEventListener("change", () => {
      renderCategoryOptionsForType(entryType.value);
      updateProgressFields();
    });
    entryStatus.addEventListener("change", updateProgressFields);

    addEntryBtn.addEventListener("click", openCreateModal);
    entryModalClose.addEventListener("click", closeModal);
    entryModalCancel.addEventListener("click", closeModal);
    entryModal.addEventListener("click", (e) => {
      if (e.target === entryModal) closeModal();
    });

    searchInputEl.addEventListener("input", () => {
      searchText = searchInputEl.value;
      renderEntries();
    });

    searchCategoryEl.addEventListener("change", () => {
      const val = searchCategoryEl.value;
      searchCategoryId = val ? Number(val) : null;
      renderEntries();
    });

    filterAmSchauenEl.addEventListener("change", () => {
      onlyAmSchauen = filterAmSchauenEl.checked;
      renderEntries();
    });

    entryForm.addEventListener("submit", async (e) => {
      e.preventDefault();

      const title = entryTitle.value.trim();
      const type = entryType.value;
      const status = entryStatus.value;
      const categoryValue = entryCategoryEl.value;
      const ratingValue = entryRating.value;
      const note = entryNote.value.trim();

      if (!title || !categoryValue) {
        alert("Titel und Kategorie sind erforderlich.");
        return;
      }

      const categoryId = Number(categoryValue);
      const rating = ratingValue ? Number(ratingValue) : null;

      let season = null, episode = null, minutes = null;
      if (status === "am_schauen") {
        if (type === "serie") {
          season = entrySeason.value ? Number(entrySeason.value) : null;
          episode = entryEpisode.value ? Number(entryEpisode.value) : null;
        } else {
          minutes = entryMinutes.value ? Number(entryMinutes.value) : null;
        }
      }

      let posterUrl = null;
      if (!editingEntryId) {
        posterUrl = await fetchPosterUrl(title, type);
      } else {
        const old = entries.find(e => e.id === editingEntryId);
        posterUrl = old?.posterUrl ?? null;
      }

      const payload = {
        title, type, status, categoryId, rating, note, posterUrl,
        season, episode, minutes
      };

      if (!editingEntryId) {
        await addDoc(entriesCollection, { ...payload, createdAt: Date.now() });
      } else {
        await updateDoc(doc(db, "entries", editingEntryId), payload);
      }

      closeModal();
      await loadEntries();
    });

    btnAllEl.addEventListener("click", () => {
      selectedCategoryId = null;
      renderCategories();
      renderEntries();
    });

    renderSearchCategoryDropdown();
    renderCategories();
    renderCategoryOptionsForType("film");
    updateProgressFields();
    loadEntries();
  </script>
</body>
</html>
